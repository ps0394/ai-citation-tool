<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Citation Benchmark Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #0078d4, #106ebe);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .widget {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .widget h3 {
            margin-top: 0;
            color: #0078d4;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .run-benchmark {
            background: #e8f4fd;
            border: 2px solid #0078d4;
        }
        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #106ebe;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .metric {
            text-align: center;
            padding: 20px;
        }
        .metric-value {
            font-size: 3em;
            font-weight: bold;
            color: #0078d4;
        }
        .metric-label {
            color: #666;
            margin-top: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .learn-domain {
            background-color: #e8f5e8;
            font-weight: bold;
        }
        
        /* Enhanced Dashboard Styles */
        .prompt-explorer {
            margin-top: 30px;
        }
        .prompt-card {
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .prompt-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .prompt-header:hover {
            background-color: #f8f9fa;
        }
        .prompt-title {
            font-weight: bold;
            color: #0078d4;
        }
        .prompt-summary {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .provider-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .provider-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .provider-chatgpt { background: #e8f5e8; color: #2d5a2d; }
        .provider-gemini { background: #fef7e0; color: #8b5a00; }
        .provider-perplexity { background: #e3f2fd; color: #1565c0; }
        
        .prompt-details {
            display: none;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        .provider-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .response-text {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #0078d4;
            margin: 10px 0;
            line-height: 1.6;
        }
        .citations-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .citation-group h4 {
            margin: 0 0 10px 0;
            color: #555;
        }
        .learn-citations h4 {
            color: #2d5a2d;
        }
        .other-citations h4 {
            color: #666;
        }
        .citation-list {
            list-style: none;
            padding: 0;
        }
        .citation-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #ccc;
        }
        .learn-citations .citation-item {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        .citation-link {
            color: #0078d4;
            text-decoration: none;
            font-weight: 500;
        }
        .citation-link:hover {
            text-decoration: underline;
        }
        .citation-domain {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .pagination button {
            padding: 8px 16px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        .pagination button.active {
            background: #0078d4;
            color: white;
        }
        .pagination button:disabled {
            background: #f5f5f5;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI Citation Benchmark</h1>
        <p>Tracking how learn.microsoft.com is cited by ChatGPT, Gemini, and Perplexity</p>
    </div>

    <div class="dashboard">
        <div class="widget run-benchmark">
            <h3>Run New Benchmark</h3>
            <p>Test AI providers with Azure/Microsoft questions:</p>
            <button onclick="runBenchmark(false)">Run with APIs</button>
            <button onclick="runBenchmark(true)">Dry Run (Demo)</button>
            <div id="status" class="status"></div>
            <div id="output"></div>
        </div>

        <div class="widget">
            <h3>Learn Citation Rate</h3>
            <div class="metric">
                <div class="metric-value" id="citationRate">--</div>
                <div class="metric-label">% citing learn.microsoft.com</div>
            </div>
        </div>

        <div class="widget">
            <h3>Total Responses</h3>
            <div class="metric">
                <div class="metric-value" id="totalResponses">--</div>
                <div class="metric-label">AI responses analyzed</div>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div class="widget">
            <h3>Citation Rate by Provider</h3>
            <canvas id="providerChart"></canvas>
        </div>

        <div class="widget">
            <h3>Top Domains Cited</h3>
            <canvas id="domainChart"></canvas>
        </div>

        <div class="widget">
            <h3>üìà Citation Trends</h3>
            <div style="margin-bottom: 10px; text-align: center;">
                <button onclick="loadTrendChart(7)" style="margin: 0 5px; padding: 5px 10px; border: 1px solid #0078d4; background: white; color: #0078d4; border-radius: 3px; cursor: pointer;">7 Days</button>
                <button onclick="loadTrendChart(30)" style="margin: 0 5px; padding: 5px 10px; border: 1px solid #0078d4; background: #0078d4; color: white; border-radius: 3px; cursor: pointer;">30 Days</button>
                <button onclick="loadTrendChart(90)" style="margin: 0 5px; padding: 5px 10px; border: 1px solid #0078d4; background: white; color: #0078d4; border-radius: 3px; cursor: pointer;">90 Days</button>
            </div>
            <canvas id="trendChart" height="400"></canvas>
        </div>
    </div>

    <!-- Enhanced Prompt Explorer Section -->
    <div class="widget prompt-explorer">
        <h3>üìä Detailed Prompt Analysis</h3>
        <p><strong>üí° Instructions:</strong> Click the colored provider badges (ChatGPT, Gemini, Perplexity) to see full AI responses and citations</p>
        <div id="dataSource" style="padding: 10px; margin: 10px 0; background: #f8f9fa; border-radius: 5px; font-style: italic; color: #666;"></div>
        
        <div class="pagination">
            <button onclick="changePage(-1)" id="prevButton">‚Üê Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button onclick="changePage(1)" id="nextButton">Next ‚Üí</button>
        </div>
        
        <div id="promptsContainer">
            <!-- Prompts will be loaded here -->
        </div>
        
        <div class="pagination">
            <button onclick="changePage(-1)" id="prevButton2">‚Üê Previous</button>
            <span id="pageInfo2">Page 1 of 1</span>
            <button onclick="changePage(1)" id="nextButton2">Next ‚Üí</button>
        </div>
    </div>

    <div class="widget">
        <h3>Recent Results</h3>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Provider</th>
                    <th>Prompt</th>
                    <th>Citations</th>
                    <th>Learn Citations</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let currentData = [];
        let providerChart = null;
        let domainChart = null;
        let trendChart = null;
        
        // Enhanced prompt analysis variables
        let enhancedData = null;
        let currentPage = 1;
        let promptsPerPage = 5;

        // Daily aggregation function for time-series analysis
        function aggregateDailyData(csvData, date) {
            const dayData = csvData.filter(row => row.date === date);
            const providers = {};
            
            dayData.forEach(row => {
                if (!providers[row.provider]) {
                    providers[row.provider] = { total: 0, learn: 0 };
                }
                if (row.citation_url !== 'NONE' && row.citation_url !== 'ERROR') {
                    providers[row.provider].total++;
                    if (row.citation_domain === 'learn.microsoft.com') {
                        providers[row.provider].learn++;
                    }
                }
            });

            // Calculate citation rates
            const rates = {};
            let totalCitations = 0;
            let totalLearnCitations = 0;

            Object.keys(providers).forEach(provider => {
                const rate = providers[provider].total > 0 ? 
                    (providers[provider].learn / providers[provider].total) * 100 : 0;
                rates[provider] = Math.round(rate * 10) / 10; // Round to 1 decimal
                totalCitations += providers[provider].total;
                totalLearnCitations += providers[provider].learn;
            });

            rates.overall = totalCitations > 0 ? 
                Math.round((totalLearnCitations / totalCitations) * 1000) / 10 : 0;

            return {
                date: date,
                rates: rates,
                totalCitations: totalCitations
            };
        }

        // Historical data loader for time-series charts
        async function loadHistoricalData(days = 30) {
            const historicalData = [];
            const today = new Date();
            
            for (let i = 0; i < days; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                try {
                    const response = await fetch(`data/results_${dateStr}.csv`);
                    if (response.ok) {
                        const csvText = await response.text();
                        const data = Papa.parse(csvText, { header: true }).data;
                        const dailyAgg = aggregateDailyData(data, dateStr);
                        historicalData.unshift(dailyAgg); // Add to beginning for chronological order
                    }
                } catch (e) {
                    // File doesn't exist for this date, continue
                    console.log(`No data file found for ${dateStr}`);
                }
            }
            
            return historicalData;
        }

        // Trend chart implementation
        async function loadTrendChart(days = 30) {
            try {
                showStatus('info', `Loading ${days} days of historical data...`);
                const historicalData = await loadHistoricalData(days);
                
                if (historicalData.length === 0) {
                    showStatus('error', 'No historical data available for trend analysis');
                    return;
                }

                const labels = historicalData.map(d => d.date);
                const datasets = [
                    {
                        label: 'Overall Citation Rate',
                        data: historicalData.map(d => d.rates.overall || 0),
                        borderColor: '#0078d4',
                        backgroundColor: 'rgba(0, 120, 212, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1
                    }
                ];

                // Add provider-specific lines if we have data
                const providers = ['ChatGPT', 'Gemini', 'Perplexity'];
                const providerColors = ['#10a37f', '#4285f4', '#20b2aa'];
                
                providers.forEach((provider, index) => {
                    const data = historicalData.map(d => d.rates[provider] || 0);
                    if (data.some(value => value > 0)) {
                        datasets.push({
                            label: provider,
                            data: data,
                            borderColor: providerColors[index],
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1
                        });
                    }
                });

                const ctx = document.getElementById('trendChart').getContext('2d');
                if (trendChart) {
                    trendChart.destroy();
                }
                
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Date'
                                },
                                type: 'category'
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Citation Rate (%)'
                                },
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `Citation Rate Trends (Last ${days} Days)`
                            },
                            legend: {
                                display: true,
                                position: 'bottom'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                callbacks: {
                                    afterBody: function(context) {
                                        const dataIndex = context[0].dataIndex;
                                        const dayData = historicalData[dataIndex];
                                        return `Total citations: ${dayData.totalCitations}`;
                                    }
                                }
                            }
                        }
                    }
                });

                showStatus('success', `Loaded ${historicalData.length} days of trend data`);
            } catch (error) {
                console.error('Error loading trend chart:', error);
                showStatus('error', 'Failed to load trend data: ' + error.message);
            }
        }

        // Enhanced data loader for detailed prompt analysis
        async function loadEnhancedData() {
            try {
                // Try to load JSON file first (has more detailed structure)
                const today = new Date().toISOString().split('T')[0];
                let jsonData = null;
                
                // Try today's JSON file
                try {
                    const response = await fetch(`data/results_${today}.json`);
                    if (response.ok) {
                        jsonData = await response.json();
                    }
                } catch (e) {
                    console.log('Today JSON file not found, trying yesterday...');
                }
                
                // Try yesterday's JSON file if today's doesn't exist
                if (!jsonData) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    try {
                        const response = await fetch(`data/results_${yesterdayStr}.json`);
                        if (response.ok) {
                            jsonData = await response.json();
                        }
                    } catch (e) {
                        console.log('Yesterday JSON file not found...');
                    }
                }
                
                // If we have JSON data, use it
                if (jsonData && jsonData.enhanced_results) {
                    enhancedData = jsonData.enhanced_results;
                    displayEnhancedPrompts();
                    document.getElementById('dataSource').textContent = `Data loaded from: results_${(jsonData.metadata && jsonData.metadata.date) || today}.json (${enhancedData.prompts.length} prompts)`;
                } else {
                    // Fall back to creating enhanced data from CSV
                    await loadEnhancedFromCSV();
                }
            } catch (error) {
                console.error('Error loading enhanced data:', error);
                document.getElementById('dataSource').textContent = 'Error loading detailed analysis data';
            }
        }

        // Fallback: Create enhanced data structure from CSV
        async function loadEnhancedFromCSV() {
            if (currentData.length === 0) {
                document.getElementById('dataSource').textContent = 'No data available for detailed analysis';
                return;
            }

            // Group data by prompt_id
            const promptGroups = {};
            currentData.forEach(row => {
                if (row.prompt_id && row.prompt) {
                    if (!promptGroups[row.prompt_id]) {
                        promptGroups[row.prompt_id] = {
                            prompt_id: row.prompt_id,
                            prompt_text: row.prompt,
                            category: 'general',
                            providers: {}
                        };
                    }
                    
                    if (!promptGroups[row.prompt_id].providers[row.provider]) {
                        promptGroups[row.prompt_id].providers[row.provider] = {
                            model: row.model || 'unknown',
                            response_text: row.response || 'No response available',
                            learn_citations: [],
                            other_citations: [],
                            citation_count: { learn: 0, other: 0, total: 0 }
                        };
                    }
                    
                    const providerData = promptGroups[row.prompt_id].providers[row.provider];
                    
                    // Add citation if it exists
                    if (row.citation_url && row.citation_url !== 'NONE' && row.citation_url !== 'ERROR') {
                        const citation = {
                            url: row.citation_url,
                            domain: row.citation_domain || 'unknown',
                            title: row.citation_url.split('/').pop() || 'Citation'
                        };
                        
                        if (row.citation_domain === 'learn.microsoft.com') {
                            providerData.learn_citations.push(citation);
                            providerData.citation_count.learn++;
                        } else {
                            providerData.other_citations.push(citation);
                            providerData.citation_count.other++;
                        }
                        providerData.citation_count.total++;
                    }
                });
            });

            enhancedData = {
                prompts: Object.values(promptGroups)
            };
            
            displayEnhancedPrompts();
            document.getElementById('dataSource').textContent = `Data created from CSV (${enhancedData.prompts.length} prompts)`;
        }

        // Display enhanced prompts with pagination
        function displayEnhancedPrompts() {
            if (!enhancedData || !enhancedData.prompts) {
                document.getElementById('promptsContainer').innerHTML = '<p>No prompt data available</p>';
                return;
            }

            const startIndex = (currentPage - 1) * promptsPerPage;
            const endIndex = startIndex + promptsPerPage;
            const pagePrompts = enhancedData.prompts.slice(startIndex, endIndex);
            
            const container = document.getElementById('promptsContainer');
            container.innerHTML = '';
            
            pagePrompts.forEach((prompt, index) => {
                const globalIndex = startIndex + index;
                const card = createPromptCard(prompt, globalIndex);
                container.appendChild(card);
            });
            
            const totalPages = Math.ceil(enhancedData.prompts.length / promptsPerPage);
            updatePaginationInfo(totalPages);
        }

        // Create prompt card (this function seems to exist but might be incomplete)
        function createPromptCard(prompt, index) {
            const card = document.createElement('div');
            card.className = 'prompt-card';
            
            const header = document.createElement('div');
            header.className = 'prompt-header';
            header.onclick = () => togglePromptDetails(index);
            
            const providers = Object.keys(prompt.providers);
            const totalCitations = providers.reduce((sum, provider) => 
                sum + (prompt.providers[provider].citation_count?.total || 0), 0);
            const learnCitations = providers.reduce((sum, provider) => 
                sum + (prompt.providers[provider].citation_count?.learn || 0), 0);
            
            header.innerHTML = `
                <div class="prompt-title">${prompt.prompt_id}: ${prompt.prompt_text.substring(0, 80)}...</div>
                <div class="prompt-summary">
                    ${providers.map(provider => {
                        const providerData = prompt.providers[provider];
                        const citationCount = providerData.citation_count?.total || 0;
                        const learnCount = providerData.citation_count?.learn || 0;
                        return `
                            <span class="provider-badge provider-${provider.toLowerCase()}" 
                                  onclick="event.stopPropagation(); toggleProviderDetails(${index}, '${provider}')">
                                ${provider}: ${citationCount} citations (${learnCount} learn.microsoft.com)
                            </span>
                        `;
                    }).join('')}
                </div>
                <span id="chevron-${index}" class="chevron">‚ñº</span>
            `;
            
            const details = document.createElement('div');
            details.className = 'prompt-details';
            details.id = `details-${index}`;
            details.style.display = 'none';
            
            providers.forEach(provider => {
                const providerData = prompt.providers[provider];
                const providerDiv = document.createElement('div');
                providerDiv.className = 'provider-details';
                providerDiv.id = `provider-${index}-${provider}`;
                providerDiv.style.display = 'none';
                
                providerDiv.innerHTML = `
                    <h4>ü§ñ ${provider} (${providerData.model})</h4>
                    <div class="response-text">
                        <strong>Response:</strong><br>
                        ${providerData.response_text.substring(0, 500)}${providerData.response_text.length > 500 ? '...' : ''}
                    </div>
                    <div class="citations-section">
                        <div class="citation-group learn-citations">
                            <h4>üìö Learn.microsoft.com Citations</h4>
                            <ul class="citation-list">
                                ${(providerData.learn_citations || []).map(citation => `
                                    <li class="citation-item">
                                        <a href="${citation.url}" class="citation-link" target="_blank">${citation.title}</a>
                                        <div class="citation-domain">${citation.domain}</div>
                                    </li>
                                `).join('')}
                            </ul>
                            ${(providerData.learn_citations || []).length === 0 ? '<p><em>No learn.microsoft.com citations found</em></p>' : ''}
                        </div>
                        <div class="citation-group other-citations">
                            <h4>üåê Other Citations</h4>
                            <ul class="citation-list">
                                ${(providerData.other_citations || []).map(citation => `
                                    <li class="citation-item">
                                        <a href="${citation.url}" class="citation-link" target="_blank">${citation.title}</a>
                                        <div class="citation-domain">${citation.domain}</div>
                                    </li>
                                `).join('')}
                            </ul>
                            ${(providerData.other_citations || []).length === 0 ? '<p><em>No other citations found</em></p>' : ''}
                        </div>
                    </div>
                `;
                details.appendChild(providerDiv);
            });

            card.appendChild(header);
            card.appendChild(details);
            return card;
        }

        async function loadLatestResults() {
            try {
                console.log('[DEBUG] Starting to load latest results...');
                // Try to load the latest CSV file
                const today = new Date().toISOString().split('T')[0];
                let csvText = null;
                
                console.log('[DEBUG] Looking for today file:', `data/results_${today}.csv`);
                
                // Try today's file first
                try {
                    const response = await fetch(`data/results_${today}.csv`);
                    console.log('[DEBUG] Today file response status:', response.status);
                    if (response.ok) {
                        csvText = await response.text();
                        console.log('[DEBUG] Today file loaded, length:', csvText.length);
                    }
                } catch (e) {
                    console.log('[DEBUG] Today file not found, error:', e.message);
                }
                
                // Try yesterday's file if today's doesn't exist
                if (!csvText) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    console.log('[DEBUG] Looking for yesterday file:', `data/results_${yesterdayStr}.csv`);
                    try {
                        const response = await fetch(`data/results_${yesterdayStr}.csv`);
                        console.log('[DEBUG] Yesterday file response status:', response.status);
                        if (response.ok) {
                            csvText = await response.text();
                            console.log('[DEBUG] Yesterday file loaded, length:', csvText.length);
                        }
                    } catch (e) {
                        console.log('[DEBUG] Yesterday file not found, error:', e.message);
                    }
                }
                
                // Try sample data if no real data exists
                if (!csvText) {
                    console.log('[DEBUG] Trying sample data file...');
                    try {
                        const response = await fetch('data/sample-results.csv');
                        console.log('[DEBUG] Sample file response status:', response.status);
                        if (response.ok) {
                            csvText = await response.text();
                            console.log('[DEBUG] Sample file loaded, length:', csvText.length);
                            showStatus('info', 'Showing sample data. Run a benchmark to see real results.');
                        }
                    } catch (e) {
                        console.log('[DEBUG] Sample file not found either, error:', e.message);
                    }
                }
                
                if (csvText) {
                    console.log('[DEBUG] Parsing CSV data...');
                    parseAndDisplayResults(csvText);
                } else {
                    console.log('[DEBUG] No CSV files found, using hardcoded sample data');
                    // Show hardcoded sample data if no files are available
                    const sampleData = `date,provider,model,prompt_id,prompt,response,citation_url,citation_domain
2026-02-10,ChatGPT,gpt-4-turbo,001,How do I deploy an Azure Function using Bicep?,"To deploy an Azure Function using Bicep, you need to define the necessary resources...",https://learn.microsoft.com/azure/azure-functions/,learn.microsoft.com
2026-02-10,ChatGPT,gpt-4-turbo,001,How do I deploy an Azure Function using Bicep?,"To deploy an Azure Function using Bicep, you need to define the necessary resources...",https://learn.microsoft.com/azure/azure-resource-manager/bicep/,learn.microsoft.com
2026-02-10,Gemini,gemini-1.5-pro,001,How do I deploy an Azure Function using Bicep?,"Based on official documentation...",https://learn.microsoft.com/en-us/azure/,learn.microsoft.com
2026-02-10,Gemini,gemini-1.5-pro,001,How do I deploy an Azure Function using Bicep?,"Based on official documentation...",https://cloud.google.com/docs/,cloud.google.com
2026-02-10,Perplexity,llama-3.1-sonar-small-128k-online,001,How do I deploy an Azure Function using Bicep?,"According to multiple sources including Microsoft Learn...",https://learn.microsoft.com/azure/azure-functions/,learn.microsoft.com
2026-02-10,Perplexity,llama-3.1-sonar-small-128k-online,001,How do I deploy an Azure Function using Bicep?,"According to multiple sources including Microsoft Learn...",https://github.com/Azure/azure-quickstart-templates,github.com
2026-02-10,ChatGPT,gpt-4-turbo,002,What is Azure Virtual Network peering?,"Azure Virtual Network peering enables connectivity...",https://learn.microsoft.com/azure/virtual-network/,learn.microsoft.com
2026-02-10,ChatGPT,gpt-4-turbo,002,What is Azure Virtual Network peering?,"Azure Virtual Network peering enables connectivity...",https://stackoverflow.com/questions/azure-vnet,stackoverflow.com
2026-02-10,Gemini,gemini-1.5-pro,002,What is Azure Virtual Network peering?,"Based on Microsoft documentation...",https://learn.microsoft.com/en-us/azure/,learn.microsoft.com
2026-02-10,Perplexity,llama-3.1-sonar-small-128k-online,002,What is Azure Virtual Network peering?,"According to official sources...",https://docs.microsoft.com/azure/,learn.microsoft.com`;
                    
                    console.log('[DEBUG] Using hardcoded sample data');
                    parseAndDisplayResults(sampleData);
                    showStatus('info', 'Showing demo data. Real benchmark results will appear here once GitHub Actions runs successfully.');
                }
                
            } catch (error) {
                console.error('[DEBUG] Error loading results:', error);
                showStatus('error', 'Error loading benchmark results: ' + error.message);
            }
        }

        function parseAndDisplayResults(csvText) {
            console.log('[DEBUG] Parsing CSV data, length:', csvText.length);
            console.log('[DEBUG] CSV preview:', csvText.substring(0, 200));
            
            Papa.parse(csvText, {
                header: true,
                complete: function(results) {
                    console.log('[DEBUG] Papa.parse complete, total rows:', results.data.length);
                    console.log('[DEBUG] Sample row:', results.data[0]);
                    
                    currentData = results.data.filter(row => row.date && row.provider);
                    console.log('[DEBUG] Filtered data length:', currentData.length);
                    
                    if (currentData.length > 0) {
                        updateDashboard();
                        updateCharts();
                        updateTable();
                        showStatus('success', `Loaded ${currentData.length} results`);
                        console.log('[DEBUG] Dashboard update complete');
                    } else {
                        console.log('[DEBUG] No valid data rows found');
                        showStatus('error', 'No valid data found in CSV file');
                    }
                },
                error: function(error) {
                    console.error('[DEBUG] Papa.parse error:', error);
                    showStatus('error', 'Error parsing CSV data: ' + error.message);
                }
            });
        }

        function updateDashboard() {
            console.log('[DEBUG] Updating dashboard with data length:', currentData.length);
            
            const totalResponses = currentData.filter(row => row.citation_url !== 'NONE' && row.citation_url !== 'ERROR').length;
            const learnCitations = currentData.filter(row => row.citation_domain === 'learn.microsoft.com').length;
            const citationRate = totalResponses > 0 ? Math.round((learnCitations / totalResponses) * 100) : 0;

            console.log('[DEBUG] Dashboard metrics:', { totalResponses, learnCitations, citationRate });
            
            // Update dashboard elements
            const totalEl = document.getElementById('totalResponses');
            const rateEl = document.getElementById('citationRate');
            
            if (totalEl) {
                totalEl.textContent = currentData.length;
                console.log('[DEBUG] Updated totalResponses to:', currentData.length);
            } else {
                console.error('[DEBUG] totalResponses element not found');
            }
            
            if (rateEl) {
                rateEl.textContent = citationRate + '%';
                console.log('[DEBUG] Updated citationRate to:', citationRate + '%');
            } else {
                console.error('[DEBUG] citationRate element not found');
            }
        }

        function updateCharts() {
            console.log('[DEBUG] Updating charts...');
            try {
                updateProviderChart();
                updateDomainChart();
                console.log('[DEBUG] Charts updated successfully');
            } catch (error) {
                console.error('[DEBUG] Error updating charts:', error);
                showStatus('error', 'Error updating charts: ' + error.message);
            }
        }

        function updateProviderChart() {
            console.log('[DEBUG] Updating provider chart...');
            try {
                const providers = {};
                currentData.forEach(row => {
                    if (!providers[row.provider]) {
                        providers[row.provider] = { total: 0, learn: 0 };
                    }
                    if (row.citation_url !== 'NONE' && row.citation_url !== 'ERROR') {
                        providers[row.provider].total++;
                        if (row.citation_domain === 'learn.microsoft.com') {
                            providers[row.provider].learn++;
                        }
                    }
                });

                const labels = Object.keys(providers);
                const data = labels.map(provider => 
                    providers[provider].total > 0 ? 
                    Math.round((providers[provider].learn / providers[provider].total) * 100) : 0
                );

                console.log('[DEBUG] Provider chart data:', { labels, data, providers });

                const chartElement = document.getElementById('providerChart');
                if (!chartElement) {
                    console.error('[DEBUG] providerChart element not found');
                    showStatus('error', 'Chart elements missing from page');
                    return;
                }

                // Ensure Chart.js is available
                if (typeof Chart === 'undefined') {
                    console.error('[DEBUG] Chart.js not available');
                    showStatus('error', 'Chart.js library not loaded');
                    return;
                }

                const ctx = chartElement.getContext('2d');
                if (providerChart) {
                    providerChart.destroy();
                }
                
                providerChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Learn Citation Rate (%)',
                            data: data,
                            backgroundColor: ['#0078d4', '#00bcf2', '#40e0d0']
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                
                console.log('[DEBUG] Provider chart created successfully');
            } catch (error) {
                console.error('[DEBUG] Error creating provider chart:', error);
            }
        }
                        }
                    }
                }
            });
        }

        function updateDomainChart() {
            const domains = {};
            currentData.forEach(row => {
                if (row.citation_domain && row.citation_domain !== 'NONE' && row.citation_domain !== 'ERROR') {
                    domains[row.citation_domain] = (domains[row.citation_domain] || 0) + 1;
                }
            });

            const sortedDomains = Object.entries(domains)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8); // Top 8 domains

            const ctx = document.getElementById('domainChart').getContext('2d');
            if (domainChart) {
                domainChart.destroy();
            }
            
            domainChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedDomains.map(d => d[0]),
                    datasets: [{
                        data: sortedDomains.map(d => d[1]),
                        backgroundColor: [
                            '#0078d4', '#00bcf2', '#40e0d0', '#7db46c',
                            '#f2c70f', '#ff8c00', '#e74c3c', '#9b59b6'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        function updateTable() {
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            
            // Group by prompt for easier reading
            const grouped = {};
            currentData.forEach(row => {
                if (!grouped[row.prompt_id]) {
                    grouped[row.prompt_id] = {
                        date: row.date,
                        prompt: row.prompt,
                        responses: []
                    };
                }
                grouped[row.prompt_id].responses.push(row);
            });

            Object.values(grouped).slice(0, 10).forEach(group => {
                const learnCitations = group.responses.filter(r => r.citation_domain === 'learn.microsoft.com').length;
                const totalCitations = group.responses.filter(r => r.citation_url !== 'NONE' && r.citation_url !== 'ERROR').length;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${group.date}</td>
                    <td>${group.responses.map(r => r.provider).join(', ')}</td>
                    <td>${group.prompt.substring(0, 80)}...</td>
                    <td>${totalCitations}</td>
                    <td class="${learnCitations > 0 ? 'learn-domain' : ''}">${learnCitations}</td>
                `;
            });
        }

        // Enhanced JSON Data Handling
        let enhancedData = null;
        let currentPage = 1;
        const promptsPerPage = 10;

        async function loadEnhancedData() {
            let dataSource = "";
            try {
                // Try to load JSON file
                const today = new Date().toISOString().split('T')[0];
                let jsonData = null;
                
                // Try today's JSON file first
                try {
                    const response = await fetch(`data/results_${today}.json`);
                    if (response.ok) {
                        jsonData = await response.json();
                        dataSource = `üìÅ Loading real data from: data/results_${today}.json`;
                    }
                } catch (e) {
                    console.log('Today JSON file not found, trying yesterday...');
                }
                
                // Try yesterday's file if today's doesn't exist
                if (!jsonData) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    try {
                        const response = await fetch(`data/results_${yesterdayStr}.json`);
                        if (response.ok) {
                            jsonData = await response.json();
                            dataSource = `üìÅ Loading real data from: data/results_${yesterdayStr}.json`;
                        }
                    } catch (e) {
                        console.log('Yesterday JSON file not found.');
                    }
                }
                
                // Use sample data if no real data exists
                if (!jsonData) {
                    jsonData = createSampleEnhancedData();
                    dataSource = "üß™ Showing sample data - Run a benchmark to see real results with your API keys";
                }
                
                enhancedData = jsonData;
                document.getElementById('dataSource').textContent = dataSource;
                displayEnhancedPrompts();
                
            } catch (error) {
                console.error('Error loading enhanced data:', error);
                enhancedData = createSampleEnhancedData();
                document.getElementById('dataSource').textContent = "üß™ Showing sample data due to loading error";
                displayEnhancedPrompts();
            }
        }

        function createSampleEnhancedData() {
            return {
                "metadata": {
                    "date": "2026-02-06",
                    "total_prompts": 5,
                    "benchmark_version": "2.0"
                },
                "prompts": [
                    {
                        "prompt_id": "001",
                        "prompt_text": "How do I deploy an Azure Function using Bicep?",
                        "category": "how-to",
                        "providers": {
                            "ChatGPT": {
                                "model": "gpt-4-turbo",
                                "response_text": "To deploy an Azure Function using Bicep, you need to create a Bicep file that defines the necessary Azure resources including the Function App, hosting plan, and storage account. Here's a comprehensive guide with step-by-step instructions...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/azure-functions/", "domain": "learn.microsoft.com", "title": "Azure Functions Documentation"},
                                    {"url": "https://learn.microsoft.com/azure/azure-resource-manager/bicep/", "domain": "learn.microsoft.com", "title": "Bicep Language"}
                                ],
                                "other_citations": [
                                    {"url": "https://github.com/Azure/azure-quickstart-templates", "domain": "github.com", "title": "Azure Quickstart Templates"}
                                ],
                                "citation_count": { "learn": 2, "other": 1, "total": 3 }
                            },
                            "Gemini": {
                                "model": "gemini-pro",
                                "response_text": "Azure Functions can be deployed using Bicep by defining infrastructure as code. This approach provides consistency and repeatability for your serverless applications...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/azure-functions/functions-infrastructure-as-code", "domain": "learn.microsoft.com", "title": "Infrastructure As Code"}
                                ],
                                "other_citations": [],
                                "citation_count": { "learn": 1, "other": 0, "total": 1 }
                            },
                            "Perplexity": {
                                "model": "llama-3.1-sonar-small-128k-online",
                                "response_text": "Bicep is Microsoft's domain-specific language for deploying Azure resources. For Azure Functions, you'll need to define several components including the Function App, App Service Plan, and supporting resources...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview", "domain": "learn.microsoft.com", "title": "Bicep Overview"}
                                ],
                                "other_citations": [
                                    {"url": "https://techcommunity.microsoft.com/blog/", "domain": "techcommunity.microsoft.com", "title": "Microsoft Tech Community"}
                                ],
                                "citation_count": { "learn": 1, "other": 1, "total": 2 }
                            }
                        }
                    },
                    {
                        "prompt_id": "002", 
                        "prompt_text": "What is Azure Virtual Network peering?",
                        "category": "concept",
                        "providers": {
                            "ChatGPT": {
                                "model": "gpt-4-turbo",
                                "response_text": "Azure Virtual Network peering allows you to connect two Azure virtual networks seamlessly. The networks appear as one for connectivity purposes. Traffic between virtual networks uses the Microsoft backbone infrastructure...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/virtual-network/virtual-network-peering-overview", "domain": "learn.microsoft.com", "title": "VNet Peering Overview"}
                                ],
                                "other_citations": [],
                                "citation_count": { "learn": 1, "other": 0, "total": 1 }
                            },
                            "Gemini": {
                                "model": "gemini-pro", 
                                "response_text": "Virtual Network peering in Azure enables you to connect VNets in the same region or across regions. This connectivity allows resources in different VNets to communicate with each other...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/virtual-network/virtual-network-peering-overview", "domain": "learn.microsoft.com", "title": "Virtual Network Peering"}
                                ],
                                "other_citations": [
                                    {"url": "https://azure.microsoft.com/pricing/details/virtual-network/", "domain": "azure.microsoft.com", "title": "VNet Pricing"}
                                ],
                                "citation_count": { "learn": 1, "other": 1, "total": 2 }
                            },
                            "Perplexity": {
                                "model": "llama-3.1-sonar-small-128k-online",
                                "response_text": "Azure VNet peering is a networking feature that connects two or more virtual networks, making them appear as a single network for connectivity purposes...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/virtual-network/", "domain": "learn.microsoft.com", "title": "Virtual Network Documentation"}
                                ],
                                "other_citations": [],
                                "citation_count": { "learn": 1, "other": 0, "total": 1 }
                            }
                        }
                    },
                    {
                        "prompt_id": "003",
                        "prompt_text": "Azure Functions vs Logic Apps ‚Äî when should I use each?",
                        "category": "comparison", 
                        "providers": {
                            "ChatGPT": {
                                "model": "gpt-4-turbo",
                                "response_text": "Azure Functions and Logic Apps serve different purposes in the Azure ecosystem. Functions are best for code-centric solutions, while Logic Apps excel at workflow orchestration. Here's when to use each...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/azure-functions/", "domain": "learn.microsoft.com", "title": "Azure Functions Overview"},
                                    {"url": "https://learn.microsoft.com/azure/logic-apps/", "domain": "learn.microsoft.com", "title": "Azure Logic Apps"}
                                ],
                                "other_citations": [],
                                "citation_count": { "learn": 2, "other": 0, "total": 2 }
                            },
                            "Gemini": {
                                "model": "gemini-pro",
                                "response_text": "Choose Azure Functions for event-driven programming and custom code execution. Logic Apps are ideal for business process automation and integration scenarios...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/logic-apps/logic-apps-overview", "domain": "learn.microsoft.com", "title": "Logic Apps Overview"}
                                ],
                                "other_citations": [],
                                "citation_count": { "learn": 1, "other": 0, "total": 1 }
                            },
                            "Perplexity": {
                                "model": "llama-3.1-sonar-small-128k-online",
                                "response_text": "The choice between Azure Functions and Logic Apps depends on your specific use case. Functions are serverless compute solutions, while Logic Apps are workflow orchestration services...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/azure-functions/functions-compare-logic-apps-ms-flow-webjobs", "domain": "learn.microsoft.com", "title": "Compare Functions Logic Apps"}
                                ],
                                "other_citations": [
                                    {"url": "https://stackoverflow.com/questions/tagged/azure-functions", "domain": "stackoverflow.com", "title": "Azure Functions Stack Overflow"}
                                ],
                                "citation_count": { "learn": 1, "other": 1, "total": 2 }
                            }
                        }
                    },
                    {
                        "prompt_id": "004",
                        "prompt_text": "Why does my Azure DevOps pipeline fail with error MSB1009?",
                        "category": "troubleshooting",
                        "providers": {
                            "ChatGPT": {
                                "model": "gpt-4-turbo", 
                                "response_text": "MSB1009 error indicates that a project file was not found. This commonly occurs in Azure DevOps pipelines when the build agent can't locate the specified .csproj or .sln file. Here are the troubleshooting steps...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/devops/pipelines/troubleshooting/", "domain": "learn.microsoft.com", "title": "Pipeline Troubleshooting"}
                                ],
                                "other_citations": [
                                    {"url": "https://github.com/Microsoft/azure-pipelines-tasks/issues/", "domain": "github.com", "title": "Azure Pipelines Tasks Issues"}
                                ],
                                "citation_count": { "learn": 1, "other": 1, "total": 2 }
                            },
                            "Gemini": {
                                "model": "gemini-pro",
                                "response_text": "Error MSB1009 typically means the build system cannot find the project file. Check your pipeline working directory and ensure the path to your project file is correct...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/devops/pipelines/build/", "domain": "learn.microsoft.com", "title": "Build Pipelines"}
                                ],
                                "other_citations": [],
                                "citation_count": { "learn": 1, "other": 0, "total": 1 }
                            },
                            "Perplexity": {
                                "model": "llama-3.1-sonar-small-128k-online",
                                "response_text": "MSB1009 is a MSBuild error indicating missing project files. In Azure DevOps context, verify your repository structure and pipeline working directory configuration...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/visualstudio/msbuild/", "domain": "learn.microsoft.com", "title": "MSBuild Documentation"}
                                ],
                                "other_citations": [
                                    {"url": "https://docs.microsoft.com/troubleshoot/", "domain": "learn.microsoft.com", "title": "Microsoft Troubleshooting"}
                                ],
                                "citation_count": { "learn": 2, "other": 0, "total": 2 }
                            }
                        }
                    },
                    {
                        "prompt_id": "005",
                        "prompt_text": "What skills are covered in the AZ-104 certification?",
                        "category": "certification",
                        "providers": {
                            "ChatGPT": {
                                "model": "gpt-4-turbo",
                                "response_text": "The AZ-104 Microsoft Azure Administrator certification covers essential skills for Azure administrators including identity management, governance, storage, compute, and virtual networking...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/certifications/azure-administrator/", "domain": "learn.microsoft.com", "title": "AZ-104 Certification"},
                                    {"url": "https://learn.microsoft.com/certifications/exams/az-104", "domain": "learn.microsoft.com", "title": "AZ-104 Exam Details"}
                                ],
                                "other_citations": [],
                                "citation_count": { "learn": 2, "other": 0, "total": 2 }
                            },
                            "Gemini": {
                                "model": "gemini-pro",
                                "response_text": "AZ-104 focuses on Azure administration fundamentals including managing Azure identities, implementing storage solutions, deploying VMs, configuring virtual networks, and monitoring Azure resources...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/azure/", "domain": "learn.microsoft.com", "title": "Azure Documentation"}
                                ],
                                "other_citations": [],
                                "citation_count": { "learn": 1, "other": 0, "total": 1 }
                            },
                            "Perplexity": {
                                "model": "llama-3.1-sonar-small-128k-online",
                                "response_text": "The AZ-104 exam tests your ability to manage Azure subscriptions and resources, implement and manage storage, deploy and manage Azure compute resources, configure and manage virtual networking, and monitor and back up Azure resources...",
                                "learn_citations": [
                                    {"url": "https://learn.microsoft.com/certifications/azure-administrator/", "domain": "learn.microsoft.com", "title": "Azure Administrator Certification"}
                                ],
                                "other_citations": [
                                    {"url": "https://azure.microsoft.com/certifications/", "domain": "azure.microsoft.com", "title": "Azure Certifications"}
                                ],
                                "citation_count": { "learn": 1, "other": 1, "total": 2 }
                            }
                        }
                    }
                ]
            };
        }

        function displayEnhancedPrompts() {
            if (!enhancedData || !enhancedData.prompts) {
                document.getElementById('promptsContainer').innerHTML = '<p>No enhanced data available. Run a benchmark to generate detailed results.</p>';
                return;
            }

            const totalPages = Math.ceil(enhancedData.prompts.length / promptsPerPage);
            const startIdx = (currentPage - 1) * promptsPerPage;
            const endIdx = Math.min(startIdx + promptsPerPage, enhancedData.prompts.length);
            const promptsToShow = enhancedData.prompts.slice(startIdx, endIdx);

            const container = document.getElementById('promptsContainer');
            container.innerHTML = '';

            promptsToShow.forEach((prompt, index) => {
                const promptCard = createPromptCard(prompt, startIdx + index);
                container.appendChild(promptCard);
            });

            // Update pagination info
            updatePaginationInfo(totalPages);
        }

        function createPromptCard(prompt, index) {
            const card = document.createElement('div');
            card.className = 'prompt-card';
            card.id = `prompt-${index}`;

            const header = document.createElement('div');
            header.className = 'prompt-header';
            header.onclick = () => togglePromptDetails(index);

            const title = document.createElement('div');
            title.innerHTML = `
                <div class="prompt-title">Prompt ${prompt.prompt_id}: ${prompt.prompt_text}</div>
                <div class="prompt-summary">
                    ${Object.keys(prompt.providers).map(provider => {
                        const data = prompt.providers[provider];
                        const total = data.citation_count.total;
                        const learn = data.citation_count.learn;
                        return `<span class="provider-badge provider-${provider.toLowerCase()}" onclick="event.stopPropagation(); toggleProviderDetails('${index}', '${provider}')">
                            ${provider}: ${learn} Learn, ${total - learn} Other citations
                        </span>`;
                    }).join('')}
                </div>
            `;

            const chevron = document.createElement('div');
            chevron.innerHTML = '‚ñº';
            chevron.id = `chevron-${index}`;

            header.appendChild(title);
            header.appendChild(chevron);

            const details = document.createElement('div');
            details.className = 'prompt-details';
            details.id = `details-${index}`;

            Object.keys(prompt.providers).forEach(provider => {
                const providerData = prompt.providers[provider];
                const providerDiv = document.createElement('div');
                providerDiv.className = 'provider-details';
                providerDiv.id = `provider-${index}-${provider}`;
                providerDiv.style.display = 'none';
                
                providerDiv.innerHTML = `
                    <h4>${provider} (${providerData.model})</h4>
                    <div class="response-text">${providerData.response_text}</div>
                    <div class="citations-section">
                        <div class="citation-group learn-citations">
                            <h4>üìö Learn.microsoft.com Citations</h4>
                            <ul class="citation-list">
                                ${providerData.learn_citations.map(citation => `
                                    <li class="citation-item">
                                        <a href="${citation.url}" class="citation-link" target="_blank">${citation.title}</a>
                                        <div class="citation-domain">${citation.domain}</div>
                                    </li>
                                `).join('')}
                            </ul>
                            ${providerData.learn_citations.length === 0 ? '<p><em>No Learn citations found</em></p>' : ''}
                        </div>
                        <div class="citation-group other-citations">
                            <h4>üåê Other Citations</h4>
                            <ul class="citation-list">
                                ${providerData.other_citations.map(citation => `
                                    <li class="citation-item">
                                        <a href="${citation.url}" class="citation-link" target="_blank">${citation.title}</a>
                                        <div class="citation-domain">${citation.domain}</div>
                                    </li>
                                `).join('')}
                            </ul>
                            ${providerData.other_citations.length === 0 ? '<p><em>No other citations found</em></p>' : ''}
                        </div>
                    </div>
                `;
                details.appendChild(providerDiv);
            });

            card.appendChild(header);
            card.appendChild(details);
            return card;
        }

        function togglePromptDetails(index) {
            const details = document.getElementById(`details-${index}`);
            const chevron = document.getElementById(`chevron-${index}`);
            
            if (details.style.display === 'none' || !details.style.display) {
                details.style.display = 'block';
                chevron.innerHTML = '‚ñ≤';
            } else {
                details.style.display = 'none';
                chevron.innerHTML = '‚ñº';
                // Hide all provider details when closing
                details.querySelectorAll('.provider-details').forEach(div => div.style.display = 'none');
            }
        }

        function toggleProviderDetails(promptIndex, provider) {
            const providerDiv = document.getElementById(`provider-${promptIndex}-${provider}`);
            const detailsDiv = document.getElementById(`details-${promptIndex}`);
            
            // Show prompt details if hidden
            if (detailsDiv.style.display !== 'block') {
                togglePromptDetails(promptIndex);
            }
            
            // Toggle provider details
            if (providerDiv.style.display === 'none' || !providerDiv.style.display) {
                // Hide all other providers first
                detailsDiv.querySelectorAll('.provider-details').forEach(div => div.style.display = 'none');
                providerDiv.style.display = 'block';
            } else {
                providerDiv.style.display = 'none';
            }
        }

        function changePage(direction) {
            if (!enhancedData || !enhancedData.prompts) {
                return; // No data to paginate
            }
            const totalPages = Math.ceil(enhancedData.prompts.length / promptsPerPage);
            currentPage = Math.max(1, Math.min(totalPages, currentPage + direction));
            displayEnhancedPrompts();
        }

        function updatePaginationInfo(totalPages) {
            const pageInfo = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('pageInfo').textContent = pageInfo;
            document.getElementById('pageInfo2').textContent = pageInfo;
            
            const hasMultiplePages = totalPages > 1;
            
            // Update button states
            ['prevButton', 'prevButton2'].forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = currentPage === 1;
                btn.style.display = hasMultiplePages ? 'block' : 'none';
            });
            
            ['nextButton', 'nextButton2'].forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = currentPage === totalPages;
                btn.style.display = hasMultiplePages ? 'block' : 'none';
            });
        }

        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[DEBUG] DOM loaded, starting initialization...');
            
            // Check if required libraries are available
            if (typeof Chart === 'undefined') {
                console.error('[DEBUG] Chart.js not loaded!');
                showStatus('error', 'Chart.js library failed to load');
                return;
            }
            
            if (typeof Papa === 'undefined') {
                console.error('[DEBUG] Papa Parse not loaded!');
                showStatus('error', 'Papa Parse library failed to load');
                return;
            }
            
            console.log('[DEBUG] Libraries loaded successfully');
            
            // Force load sample data immediately to ensure dashboard works
            loadSampleData();
            
            // Try to load real data
            loadLatestResults();
            loadEnhancedData();
            loadTrendChart(30);
        });
        
        // Force load with embedded sample data to guarantee dashboard works
        function loadSampleData() {
            console.log('[DEBUG] Loading embedded sample data...');
            
            const sampleData = [
                {
                    date: '2026-02-10',
                    provider: 'ChatGPT',
                    model: 'gpt-4-turbo',
                    prompt_id: '001',
                    prompt: 'How do I deploy an Azure Function using Bicep?',
                    response: 'To deploy an Azure Function using Bicep, you need to define the necessary resources...',
                    citation_url: 'https://learn.microsoft.com/azure/azure-functions/',
                    citation_domain: 'learn.microsoft.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'ChatGPT',
                    model: 'gpt-4-turbo',
                    prompt_id: '001',
                    prompt: 'How do I deploy an Azure Function using Bicep?',
                    response: 'To deploy an Azure Function using Bicep, you need to define the necessary resources...',
                    citation_url: 'https://learn.microsoft.com/azure/azure-resource-manager/bicep/',
                    citation_domain: 'learn.microsoft.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'Gemini',
                    model: 'gemini-1.5-pro',
                    prompt_id: '001',
                    prompt: 'How do I deploy an Azure Function using Bicep?',
                    response: 'Based on official documentation, Bicep provides a declarative syntax...',
                    citation_url: 'https://learn.microsoft.com/en-us/azure/',
                    citation_domain: 'learn.microsoft.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'Gemini',
                    model: 'gemini-1.5-pro',
                    prompt_id: '001',
                    prompt: 'How do I deploy an Azure Function using Bicep?',
                    response: 'Based on official documentation, Bicep provides a declarative syntax...',
                    citation_url: 'https://cloud.google.com/docs/',
                    citation_domain: 'cloud.google.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'Perplexity',
                    model: 'llama-3.1-sonar-small-128k-online',
                    prompt_id: '001',
                    prompt: 'How do I deploy an Azure Function using Bicep?',
                    response: 'According to multiple sources including Microsoft Learn...',
                    citation_url: 'https://learn.microsoft.com/azure/azure-functions/',
                    citation_domain: 'learn.microsoft.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'Perplexity',
                    model: 'llama-3.1-sonar-small-128k-online',
                    prompt_id: '001',
                    prompt: 'How do I deploy an Azure Function using Bicep?',
                    response: 'According to multiple sources including Microsoft Learn...',
                    citation_url: 'https://github.com/Azure/azure-quickstart-templates',
                    citation_domain: 'github.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'ChatGPT',
                    model: 'gpt-4-turbo',
                    prompt_id: '002',
                    prompt: 'What is Azure Virtual Network peering?',
                    response: 'Azure Virtual Network peering enables connectivity between virtual networks...',
                    citation_url: 'https://learn.microsoft.com/azure/virtual-network/',
                    citation_domain: 'learn.microsoft.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'ChatGPT',
                    model: 'gpt-4-turbo',
                    prompt_id: '002',
                    prompt: 'What is Azure Virtual Network peering?',
                    response: 'Azure Virtual Network peering enables connectivity between virtual networks...',
                    citation_url: 'https://stackoverflow.com/questions/azure-vnet',
                    citation_domain: 'stackoverflow.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'Gemini',
                    model: 'gemini-1.5-pro',
                    prompt_id: '002',
                    prompt: 'What is Azure Virtual Network peering?',
                    response: 'Based on Microsoft documentation, VNet peering connects networks...',
                    citation_url: 'https://learn.microsoft.com/en-us/azure/',
                    citation_domain: 'learn.microsoft.com'
                },
                {
                    date: '2026-02-10',
                    provider: 'Perplexity',
                    model: 'llama-3.1-sonar-small-128k-online',
                    prompt_id: '002',
                    prompt: 'What is Azure Virtual Network peering?',
                    response: 'According to official sources, VNet peering enables seamless connectivity...',
                    citation_url: 'https://docs.microsoft.com/azure/',
                    citation_domain: 'learn.microsoft.com'
                }
            ];
            
            // Set the data and update dashboard immediately
            currentData = sampleData;
            console.log('[DEBUG] Sample data loaded, updating dashboard...');
            
            updateDashboard();
            updateCharts();
            updateTable();
            
            // Create simple enhanced data for prompt analysis
            enhancedData = {
                prompts: [
                    {
                        prompt_id: "001",
                        prompt_text: "How do I deploy an Azure Function using Bicep?",
                        category: "deployment",
                        providers: {
                            "ChatGPT": {
                                model: "gpt-4-turbo",
                                response_text: "To deploy an Azure Function using Bicep, you need to define the necessary resources including the function app, hosting plan, and storage account...",
                                learn_citations: [
                                    {url: "https://learn.microsoft.com/azure/azure-functions/", domain: "learn.microsoft.com", title: "Azure Functions Documentation"},
                                    {url: "https://learn.microsoft.com/azure/azure-resource-manager/bicep/", domain: "learn.microsoft.com", title: "Bicep Documentation"}
                                ],
                                other_citations: [],
                                citation_count: { learn: 2, other: 0, total: 2 }
                            },
                            "Gemini": {
                                model: "gemini-1.5-pro", 
                                response_text: "Based on official documentation, Bicep provides a declarative syntax for deploying Azure resources...",
                                learn_citations: [
                                    {url: "https://learn.microsoft.com/en-us/azure/", domain: "learn.microsoft.com", title: "Azure Documentation"}
                                ],
                                other_citations: [
                                    {url: "https://cloud.google.com/docs/", domain: "cloud.google.com", title: "Google Cloud Docs"}
                                ],
                                citation_count: { learn: 1, other: 1, total: 2 }
                            },
                            "Perplexity": {
                                model: "llama-3.1-sonar-small-128k-online",
                                response_text: "According to multiple sources including Microsoft Learn, you can deploy Azure Functions using Bicep templates...",
                                learn_citations: [
                                    {url: "https://learn.microsoft.com/azure/azure-functions/", domain: "learn.microsoft.com", title: "Azure Functions Documentation"}
                                ],
                                other_citations: [
                                    {url: "https://github.com/Azure/azure-quickstart-templates", domain: "github.com", title: "Azure Quickstart Templates"}
                                ],
                                citation_count: { learn: 1, other: 1, total: 2 }
                            }
                        }
                    }
                ]
            };
            
            displayEnhancedPrompts();
            
            showStatus('success', 'Sample data loaded successfully! Dashboard is working.');
            console.log('[DEBUG] Sample data initialization complete');
        }
        
        // Status display function
        function showStatus(type, message) {
            console.log(`[DEBUG] Status: ${type} - ${message}`);
            
            let statusElement = document.getElementById('status');
            if (!statusElement) {
                // Create status element if it doesn't exist
                statusElement = document.createElement('div');
                statusElement.id = 'status';
                statusElement.className = 'status';
                
                // Insert at top of page
                const header = document.querySelector('.header');
                if (header && header.parentNode) {
                    header.parentNode.insertBefore(statusElement, header.nextSibling);
                } else {
                    document.body.insertBefore(statusElement, document.body.firstChild);
                }
            }
            
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            // Auto-hide success and info messages after 5 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>#   D a s h b o a r d   u p d a t e d :   0 2 / 0 6 / 2 0 2 6   1 1 : 5 6 : 4 1 
 
 